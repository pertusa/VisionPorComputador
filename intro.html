
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="install.html">
      
      
        <link rel="next" href="imagenvideo.html">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>T1- Introducción - Visión por Computador</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="Teal" data-md-color-accent="Teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tema-1-introduccion-a-opencv" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="." title="Visión por Computador" class="md-header__button md-logo" aria-label="Visión por Computador" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Visión por Computador
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              T1- Introducción
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Visión por Computador" class="md-nav__button md-logo" aria-label="Visión por Computador" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Visión por Computador
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="install.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Instalación de OpenCV
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    T1- Introducción
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="intro.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    T1- Introducción
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#carga-y-visualizacion-de-imagenes" class="md-nav__link">
    <span class="md-ellipsis">
      Carga y visualización de imágenes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Carga y visualización de imágenes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carga-de-imagenes" class="md-nav__link">
    <span class="md-ellipsis">
      Carga de imágenes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagenes-en-opencv" class="md-nav__link">
    <span class="md-ellipsis">
      Imágenes en OpenCV
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guardar-imagenes" class="md-nav__link">
    <span class="md-ellipsis">
      Guardar imágenes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Guardar imágenes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ejercicio" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Persistencia
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elementos-visuales" class="md-nav__link">
    <span class="md-ellipsis">
      Elementos visuales
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#video" class="md-nav__link">
    <span class="md-ellipsis">
      Vídeo
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="imagenvideo.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    T2- Imagen digital y vídeo
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="transformaciones.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    T3- Transformaciones
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="deteccion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    T4- Detección
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#carga-y-visualizacion-de-imagenes" class="md-nav__link">
    <span class="md-ellipsis">
      Carga y visualización de imágenes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Carga y visualización de imágenes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#carga-de-imagenes" class="md-nav__link">
    <span class="md-ellipsis">
      Carga de imágenes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#imagenes-en-opencv" class="md-nav__link">
    <span class="md-ellipsis">
      Imágenes en OpenCV
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#guardar-imagenes" class="md-nav__link">
    <span class="md-ellipsis">
      Guardar imágenes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Guardar imágenes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ejercicio" class="md-nav__link">
    <span class="md-ellipsis">
      Ejercicio
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#persistencia" class="md-nav__link">
    <span class="md-ellipsis">
      Persistencia
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#elementos-visuales" class="md-nav__link">
    <span class="md-ellipsis">
      Elementos visuales
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#video" class="md-nav__link">
    <span class="md-ellipsis">
      Vídeo
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tema-1-introduccion-a-opencv">Tema 1- Introducción a OpenCV<a class="headerlink" href="#tema-1-introduccion-a-opencv" title="Permanent link">&para;</a></h1>
<p>En este tema veremos las funcionalidades básicas de OpenCV: cargar una imagen o un vídeo, mostrarlo por pantalla y guardar ficheros.</p>
<!---
TUTORIAL DE PYTHON: https://colab.research.google.com/github/cs231n/cs231n.github.io/blob/master/python-colab.ipynb#scrollTo=1L4Am0QATgOc
--->

<h2 id="carga-y-visualizacion-de-imagenes">Carga y visualización de imágenes<a class="headerlink" href="#carga-y-visualizacion-de-imagenes" title="Permanent link">&para;</a></h2>
<p>Vamos a comprobar que la instalación se ha hecho de forma correcta ejecutando el siguiente programa de ejemplo.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

<span class="c1"># Gestión de parámetros</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Programa para cargar y mostrar una imagen&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--imagen&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;lena.jpg&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># Cargamos la imagen indicada por el usuario (por defecto, en color)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">imagen</span><span class="p">)</span>

<span class="c1"># Comprobamos que la imagen se ha podido leer</span>
<span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error al cargar la imagen&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">imagen</span><span class="p">)</span>
    <span class="n">quit</span><span class="p">()</span>

<span class="c1"># Mostramos la imagen en una ventana con el título &quot;Imagen&quot;</span>
<span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Ventana&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">WINDOW_AUTOSIZE</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Ventana&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>

<span class="c1"># Esperar a pulsar una tecla en la ventana para cerrarla</span>
<span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>Primero guardamos este fichero con el nombre <code>lectura.py</code>. Para probar el código, descargamos esta imagen de ejemplo:</p>
<p><img alt="lena" src="images/intro/lena.jpg" /></p>
<p>Y a continuación ejecutamos el programa de la siguiente forma:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>lectura.py
</code></pre></div>
<blockquote>
<p>En el caso de Windows, en lugar de poner <code>python3</code> hay que escribir sólo <code>python</code>.</p>
</blockquote>
<p>Como puede verse, se crea una ventana con la imagen, por defecto <code>lena.jpg</code>. Esta ventana se cerrará cuando pulsemos una tecla.</p>
<p>Podemos ejecutar el programa con otra imagen indicando la opción <code>--imagen</code> o alternativamente la versión corta, <code>-i</code>:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>lectura.py<span class="w"> </span>--imagen<span class="w"> </span>otraimagen.jpg
<span class="c1"># Equivalente a: python3 lectura.py -i otraimagen.jpg</span>
</code></pre></div>
<p>Vamos a analizar este código en detalle. En la primera línea, el programa incluye OpenCV. Esto debemos hacerlo siempre que queramos usar la librería. También es conveniente incluir la librería <code>numpy</code>, ya que es la que usa OpenCV para gestionar los arrays y por tanto nos permite acceder directamente a los valores de intensidad de las imágenes. A veces es posible que necesitemos incluir algún fichero de cabecera adicional, como en este caso la librería <code>argparse</code> que sirve para gestionar los argumentos del programa.</p>
<p>La librería <code>argparse</code> se encarga de comprobar que el usuario ha introducido los parámetros especificados. Si falta algún parámetro se usan unos valores por defecto. Cuando un parámetro es opcional suele indicar que comience por <code>--</code>, aunque por defecto todos los parámetros son opcionales a no ser que se añada la opción <code>required=True</code>. A los parámetros sin valor por defecto se les asigna <code>None</code>, y esto es lo que recibe el programa si el usuario no establece su valor.</p>
<p>A continuación leemos una imagen con <code>imread</code> usando el nombre de fichero que se le pasa por parámetro y la guardamos en una matriz llamada <code>img</code>. Cada vez que intentemos cargar una imagen es importante comprobar que se ha podido leer  correctamente.</p>
<p>En este punto ya tenemos la imagen cargada en una matriz. Podríamos procesarla, pero de momento sólo vamos a mostrarla en una ventana. Para ello creamos una ventana con el nombre <em>Ventana</em> de tamaño variable, y llamamos al método <code>imshow</code> para mostrar la imagen en la ventana.</p>
<blockquote>
<p>En este ejemplo la llamada a <code>namedWindow</code> puede omitirse sin consecuencias. Si <code>imshow</code> recibe como primer parámetro el nombre de una ventana que todavía no está creada, ésta se crea automáticamente con los parámetros por defecto.</p>
</blockquote>
<p>Siempre que mostremos una imagen en pantalla debemos llamar a la función <code>waitKey(0)</code> para que la ventana se cierre cuando se pulse una tecla. Si no añadimos esta línea, la ventana no llegará a aparecer (mejor dicho, aparecerá y se cerrará de inmediato).</p>
<h3 id="carga-de-imagenes">Carga de imágenes<a class="headerlink" href="#carga-de-imagenes" title="Permanent link">&para;</a></h3>
<p>La siguiente instrucción carga en una matriz la imagen cuyo nombre recibe por parámetro.</p>
<div class="highlight"><pre><span></span><code><span class="n">image</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;lena.jpg&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Como sabes, las imágenes digitales se representan con matrices.</p>
<p><img alt="Mat example" src="images/intro/MatBasicImageForComputer.jpg" /></p>
<p>Los formatos principales de imágenes soportadas por OpenCV son:</p>
<ul>
<li>Windows bitmaps (<code>bmp</code>, <code>dib</code>)</li>
<li>Portable image formats (<code>pbm</code>, <code>pgm</code>, <code>ppm</code>)</li>
<li>Sun rasters (<code>sr</code>, <code>ras</code>)</li>
</ul>
<p>También soporta otros formatos a través de librerías auxiliares:</p>
<ul>
<li>JPEG (<code>jpeg</code>, <code>jpg</code>, <code>jpe</code>)</li>
<li>JPEG 2000 (<code>jp2</code>)</li>
<li>Portable Network Graphics (<code>png</code>)</li>
<li>TIFF (<code>tiff</code>, <code>tif</code>)</li>
<li>WebP (<code>webp</code>).</li>
</ul>
<p>La función <code>imread</code> tiene un parámetro opcional. Cuando carguemos una imagen en escala de grises debemos usar <code>IMREAD_GRAYSCALE</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cargamos la imagen (tanto si está en color como si no) en escala de grises</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;lena.jpg&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span>
</code></pre></div>
<p>Esto es porque la opción por defecto es <code>IMREAD_COLOR</code>, y por tanto se cargará la imagen con 3 canales independientemente de que esté o no en escala de grises. Estos son los tres tipos de opciones que podemos usar con <code>imread</code>:</p>
<ul>
<li><code>cv.IMREAD_GRAYSCALE</code>: Cargamos la imagen en escala de grises.</li>
<li><code>cv.IMREAD_COLOR</code>: Cargamos la imagen en color. Si tenía canal alpha (transparente), se ignora.</li>
<li><code>cv.IMREAD_UNCHANGED</code>: Cargamos la imagen tal como es incluyendo el canal alpha si lo tuviera.</li>
</ul>
<blockquote>
<p>En general, cuando necesites ayuda sobre la sintaxis de cualquier función de OpenCV, puedes escribir desde el mismo código en python: <code>help(cv.imshow)</code>, reemplazando <code>imshow</code> por el nombre de la función de la que deseas obtener ayuda.</p>
</blockquote>
<h3 id="imagenes-en-opencv">Imágenes en OpenCV<a class="headerlink" href="#imagenes-en-opencv" title="Permanent link">&para;</a></h3>
<!---
https://docs.opencv.org/4.5.1/d5/d98/tutorial_mat_operations.html
--->

<p>En python, OpenCV usa arrays <code>numpy</code> para almacenar las imágenes. Para usar esta librería en nuestro código, tenemos que importarla al principio:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</code></pre></div>
<p>Una vez importada podemos crear una matriz de cualquier tamaño, contenga o no los datos de una imagen:</p>
<div class="highlight"><pre><span></span><code><span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div>
<p>En este ejemplo hemos creado una matriz de 100x100x3 (podría corresponder con una imagen de 100 filas por 100 columnas con 3 canales), inicializada con el valor rojo (0,0,255), y de tipo <code>uint8</code> (8 bits). Este tipo de dato es el estándar para crear imágenes con una profundidad de 8 bits en python (en el caso de C++ es <code>uchar</code> en lugar de <code>uint8</code>). Con 8 bits se pueden representar valores que van desde 0 a 255.</p>
<blockquote>
<p>Si visualizas esta imagen con <code>imshow</code> verás que es roja. Esto es porque el valor rojo se representa en el último canal debido a que OpenCV carga las imágenes en modo <strong>BGR</strong> en lugar del estándar RGB. Es decir, el canal 0 es el azul, el canal 1 el verde, y el canal 2 el rojo. </p>
</blockquote>
<p>Además del tipo <code>uint8</code>, que es el más común para imágenes, un array de numpy puede ser de <a href="https://numpy.org/devdocs/user/basics.types.html">cualquiera de estos tipos</a>.</p>
<p>Existen varias alternativas para asignar valores a una matriz que ya está creada, por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="n">img</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="c1"># solo si la imagen es de 1 canal</span>
<span class="n">img</span><span class="p">[::]</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Para cambiar todos los valores por (255,0,0)</span>
</code></pre></div>
<p>Para más información sobre la sintaxis de acceso a arrays de <code>numpy</code> puedes consultar <a href="https://cs231n.github.io/python-numpy-tutorial/#arrays">esta ayuda</a>.</p>
<!---   https://numpy.org/doc/stable/reference/arrays.indexing.html).
-->

<p>En caso de que quisiéramos inicializar todos los valores de la matriz a 0, a 1 o a cualquier otro valor también podríamos indicarlo:</p>
<div class="highlight"><pre><span></span><code><span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># Inicialización con ceros</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># Inicialización con unos</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                <span class="p">[[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
                <span class="p">[[</span><span class="mi">255</span> <span class="p">,</span><span class="mi">0</span> <span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># Inicialización de una matriz de tamaño 3x2x3 con todos los píxeles de color azul</span>
</code></pre></div>
<p>En python, para copiar una variable en otra debemos llevar cuidado con usar el símbolo igual. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="n">x</span> <span class="o">=</span> <span class="n">img</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</code></pre></div>
<p>Si después de ejecutar este código modificamos <code>img</code> cambiará también el valor de <code>x</code> pero no el de <code>y</code>. Esto es porque el operador asignación (<code>=</code>) no hace una copia de la matriz, sino que crea un puntero que apunta a la variable. Para hacer una copia es necesario el método <code>copy</code>.</p>
<p>Para acceder a valores individuales de una matriz podemos hacer uso de las siguientes opciones:</p>
<div class="highlight"><pre><span></span><code><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]])</span>    <span class="c1"># Crea una matriz de 2x3</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>   <span class="c1"># Imprime &quot;1 2 4&quot;</span>
<span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Cambia a 2 el valor de la posición 0,0</span>
</code></pre></div>
<p>Si queremos obtener información sobre la estructura de la matriz podemos usar la siguiente instrucción:</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="c1"># Imprime el tipo de la matriz</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># Imprime las dimensiones &quot;(2, 3)&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>  <span class="c1"># Imprime el número total de dimensiones (2)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>  <span class="c1"># Imprime el número de elementos que tenemos en el array (6)</span>
</code></pre></div>
<p>Podemos hacer multitud de operaciones con arrays <code>numpy</code>, tales como invertir matrices, transponerlas, etc.</p>
<p>En numpy se puede seleccionar parte de un array de forma sencilla, como se puede ver en el siguiente ejemplo extraido de la <a href="https://numpy.org/devdocs/user/absolute_beginners.html">ayuda de numpy</a>: </p>
<div class="highlight"><pre><span></span><code><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># 2</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># (1,2)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># (2,3)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="c1"># (2, 3)</span>
</code></pre></div>
<p><img alt="lena" src="images/intro/np_indexing.png" /></p>
<p>Para acceder de forma iterativa a todos los elementos de un array se puede usar el siguiente bucle:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<p>En el caso de una imagen para la que queramos iterar elemento a elemento:</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">img</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</code></pre></div>
<p>Si queremos acceder a una una imagen usando índices en lugar de iteradores se puede utilizar <code>range</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span> 
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>  
      <span class="nb">print</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
</code></pre></div>
<p>También es posible crear una matriz que almacene una región de interés (una zona rectangular) de otra imagen:</p>
<div class="highlight"><pre><span></span><code><span class="n">r</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y1</span><span class="p">:</span><span class="n">y2</span><span class="p">,</span> <span class="n">x1</span><span class="p">:</span><span class="n">x2</span><span class="p">]</span>
</code></pre></div>
<p>Donde <code>(x1,y1)</code> son las coordenadas de la esquina superior izquierda del rectángulo que queremos recortar, y <code>(x2,y2)</code> son las coordenadas de la esquina inferior derecha.</p>
<p>Puedes probar este programa de ejemplo para ver cómo se extrae una subimagen, esta vez usando la función <code>selectROI</code> que nos permite seleccionar una región de interés mediante el interfaz de OpenCV:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cv</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;lena.jpg&#39;</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">selectROI</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

<span class="n">imgCrop</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

<span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Crop&#39;</span><span class="p">,</span> <span class="n">imgCrop</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>A veces es necesario cambiar el tipo de dato de un array o matriz. Podemos hacer este cambio de forma sencilla usando los tipos <code>numpy</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="c1"># Conversión a float</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intc</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="c1"># Conversión a int</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="c1"># Conversión a uint8</span>
</code></pre></div>
<!----
dst = src.astype(float) # Para pasar un array a float
dst = src.astype(int) # Para pasar un array a int
dst = src.astype(np.uint8) # Para pasar un array a uint8
---->

<p>Hay veces en las que la conversión de tipos no puede hacerse directamente, por ejemplo cuando convertimos una matriz <code>float32</code>  en <code>uint8</code>, ya que podemos salirnos de rango (en el primer caso representamos la variable con 32 bits, en el segundo con 8). Para evitar esto se suele aplicar normalización. Por ejemplo, si tenemos una matriz <code>m</code> de tipo <code>float32</code> podemos hacer la conversión de la siguiente forma:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Normalizamos los valores entre 0 y 255</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">-</span> <span class="n">m</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">/</span><span class="n">m</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mi">255</span>

<span class="c1"># Ahora ya se puede convertir a uint8</span>
<span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</code></pre></div>
<!----
## Otros tipos básicos

Además de la clase `Mat`, OpenCV define otros tipos básicos. Todos ellos tienen sobrecargado el operador salida, por lo que podemos mostrar su valor usando `<<` como con cualquier otra variable.

* **VecAB**. Se pueden declarar vectores en el formato `VecAB`, donde A (número de dimensiones) es un valor entre 2 y 5, y B es el tipo de dato: b (uchar), s (short), i (int), f (float) o d (double). Por ejemplo:

<div class="highlight"><pre><span></span><code><span class="n">Vec3d</span><span class="w"> </span><span class="nf">v</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span><span class="w"> </span><span class="mf">2.2</span><span class="p">,</span><span class="w"> </span><span class="mf">3.3</span><span class="p">);</span>
<span class="n">Vec3b</span><span class="w"> </span><span class="nf">bgr</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
</code></pre></div>

Para vectores de más dimensiones debemos usar la clase `vector` de C++.

* **Scalar**. Nos permite declarar un vector de una dimensión que contiene como máximo 4 valores escalares (reales). Por ejemplo:

<div class="highlight"><pre><span></span><code><span class="n">Scalar</span><span class="w"> </span><span class="nf">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span><span class="w"> </span><span class="c1">// Imprime 3</span>
</code></pre></div>

Hay funciones en OpenCV que necesitan parámetros escalares, como el constructor de `Mat` que hemos visto anteriormente.

* **PointAB**. Se suele usar para representar, por ejemplo, puntos de contorno (la silueta de un objeto). La sintaxis es `PointAB`, donde A es la dimensión (2 o 3), y B es el tipo de dato: i (`int`), f (`float`), o d (`double`). Por ejemplo:

<div class="highlight"><pre><span></span><code><span class="n">Point3d</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">p</span><span class="p">.</span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>

* **Size**. Especifica un tamaño (anchura por altura). Por ejemplo:

<div class="highlight"><pre><span></span><code><span class="n">Size</span><span class="w"> </span><span class="n">s</span><span class="p">;</span>
<span class="n">s</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="n">s</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">40</span><span class="p">;</span>
</code></pre></div>

* **Rect**. La clase rectángulo es parecida a `Size` pero indicando unas coordenadas de origen. Ejemplo:

<div class="highlight"><pre><span></span><code><span class="n">Rect</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
<span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</code></pre></div>


## Acceso a los píxeles

Para recorrer los valores de una matriz que tiene un canal y es de tipo `unsigned char`, podemos usar el método `at`:

<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">channels</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
<span class="w">          </span><span class="n">uchar</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">uchar</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

En el caso de que tengamos una matriz de más canales (por ejemplo, una imagen de color):

<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">channels</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">uchar</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Vec3b</span><span class="w"> </span><span class="n">pixel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="n">Vec3b</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
<span class="w">      </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">      </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">      </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pixel</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

En OpenCV hay muchas formas de acceder a los píxeles individuales y algunas de ellas son más eficientes que `at`, aunque también hacen el código algo más lioso. El problema de `at` es que necesita calcular la posición exacta de memoria de la fila y columna de un píxel. Una alternativa muy eficiente y frecuentemente usada es esta:

<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">channels</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">uchar</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rows</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Vec3b</span><span class="o">*</span><span class="w"> </span><span class="n">pixelRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">ptr</span><span class="o">&lt;</span><span class="n">Vec3b</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">cols</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pixelRow</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
<span class="w">      </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pixelRow</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
<span class="w">      </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pixelRow</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

También podemos usar iteradores (`MatIterator`) para movernos por todos los píxeles, pero en esta asignatura se desaconseja (es limpio, pero más ineficiente que `at`).

-->

<h2 id="guardar-imagenes">Guardar imágenes<a class="headerlink" href="#guardar-imagenes" title="Permanent link">&para;</a></h2>
<p>Para guardar una imagen en disco se usa la función <code>imwrite</code> de OpenCV. Ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="n">cv</span><span class="p">.</span><span class="n">imwrite</span><span class="p">(</span><span class="err">&#39;</span><span class="n">output</span><span class="p">.</span><span class="n">jpg</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">img</span><span class="p">)</span>
</code></pre></div>
<p>Esta función determina el formato del fichero de salida a partir de la extensión proporcionada en su nombre (en este caso, JPG). Existe un tercer parámetro opcional en el que podemos indicar un array con opciones de escritura. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;compress.png&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span>  <span class="p">[</span><span class="n">cv</span><span class="o">.</span><span class="n">IMWRITE_PNG_COMPRESSION</span><span class="p">,</span> <span class="mi">9</span><span class="p">])</span> <span class="c1"># Compresión PNG de nivel 9</span>
</code></pre></div>
<p>Como hemos visto podemos guardar imágenes con <code>imwrite</code>, pero hay casos en los que esta operación puede fallar (por ejemplo, cuando intentamos acceder a un directorio sin permisos). Si esto ocurre, el método devolverá <code>false</code>. Si queremos saber si se ha guardado correctamente la imagen, tenemos que comprobarlo (es recomendable hacerlo siempre):</p>
<div class="highlight"><pre><span></span><code><span class="n">writeStatus</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s1">&#39;img.jpg&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
<span class="k">if</span> <span class="n">writeStatus</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Imagen guardada&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error al guardar la imagen&#39;</span><span class="p">)</span> <span class="c1"># Excepción u otro problema de escritura</span>
</code></pre></div>
<hr />
<h3 id="ejercicio">Ejercicio<a class="headerlink" href="#ejercicio" title="Permanent link">&para;</a></h3>
<p>Haz un programa llamado <code>grayscale.py</code> que lea una imagen en color y la guarde en escala de grises. El programa recibirá como argumento el nombre del fichero de la imagen en color y el del fichero en el que vamos a almacenar la misma imagen pero en escala de grises. Se proporciona la sintaxis de <code>argParse</code> para este ejercicio:</p>
<div class="highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;Programa para cargar una imagen y guardarla en escala de grises&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--entrada&#39;</span><span class="p">,</span> <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;lena.jpg&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--salida&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;lenaGray.jpg&#39;</span><span class="p">)</span>
</code></pre></div>
<p>Si la imagen no puede cargarse o guardarse, el programa debe imprimir el mensaje <code>Error al cargar la imagen</code> o <code>Error al guardar la imagen</code> respectivamente.</p>
<hr />
<h2 id="persistencia">Persistencia<a class="headerlink" href="#persistencia" title="Permanent link">&para;</a></h2>
<p>Además de las funciones específicas para leer y escribir imágenes y vídeo, en OpenCV hay otra forma genérica de guardar o cargar datos. Esto se conoce como persistencia de datos. Los valores de los objetos y variables en el programa pueden guardarse (<em>serializados</em>) en disco, lo cual es útil para almacenar resultados y cargar datos de configuración.</p>
<p>Estos datos suelen guardarse en un fichero <code>xml</code> mediante un diccionario (en algunos lenguajes de programación como C++, a los diccionarios se les llama también <em>mapas</em>) usando pares clave/valor. Por ejemplo, si quisiéramos guardar una variable que contiene el número de objetos detectados en una imagen:</p>
<div class="highlight"><pre><span></span><code><span class="n">fs</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">FileStorage</span><span class="p">(</span><span class="s1">&#39;config.xml&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">FileStorage_WRITE</span><span class="p">)</span>
<span class="c1"># Abrimos el fichero para escritura</span>
<span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;numero_objetos&#39;</span><span class="p">,</span> <span class="n">num_objetos</span><span class="p">)</span> <span class="c1"># Guardamos el numero de objetos</span>
<span class="n">fs</span><span class="o">.</span><span class="n">release</span><span class="p">()</span> <span class="c1"># Cerramos el fichero</span>
</code></pre></div>
<p>Asumiendo que nuestra variable contiene el valor 10, se almacenará en disco el siguiente fichero <code>config.xml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;opencv_storage&gt;</span>
<span class="nt">&lt;numero_objetos&gt;</span>10<span class="nt">&lt;/numero_objetos&gt;</span>
<span class="nt">&lt;/opencv_storage&gt;</span>
</code></pre></div>
<p>Si posteriormente queremos cargar esta información del fichero, podemos usar el siguiente código:</p>
<div class="highlight"><pre><span></span><code><span class="n">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cv</span><span class="p">.</span><span class="n">FileStorage</span><span class="p">(</span><span class="err">&#39;</span><span class="n">config</span><span class="p">.</span><span class="n">xml</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">cv</span><span class="p">.</span><span class="n">FileStorage_READ</span><span class="p">)</span>
<span class="n">num_objetos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fs</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="err">&#39;</span><span class="n">numero_objetos</span><span class="err">&#39;</span><span class="p">)</span>
<span class="n">fs</span><span class="p">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>
<h2 id="elementos-visuales">Elementos visuales<a class="headerlink" href="#elementos-visuales" title="Permanent link">&para;</a></h2>
<p>Como hemos visto al principio, podemos crear una ventana para mostrar una imagen mediante la función <code>namedWindow</code>. El segundo parámetro que recibe puede ser:</p>
<ul>
<li><code>cv.WINDOW_NORMAL</code>: El usuario puede cambiar el tamaño de la ventana una vez se muestra por pantalla.</li>
<li><code>cv.WINDOW_AUTOSIZE</code>: El tamaño de la ventana se ajusta al tamaño de la imagen y el usuario no puede redimensionarla. Es la opción por defecto.</li>
<li><code>cv.WINDOW_OPENGL</code>: Se crea la ventana con soporte para OpenGL (no es necesario en esta asignatura).</li>
</ul>
<p>Dentro de la ventana de OpenCV en la que mostramos la imagen podemos añadir <em>trackbars</em>, botones, capturar la posición del ratón, etc. En este <a href="https://docs.opencv.org/4.8.0/d7/dfc/group__highgui.html">enlace</a> podemos ver los métodos y constantes relacionados con la gestión del entorno visual estándar.</p>
<p>Para capturar la posición del ratón podemos usar el método <code>setMouseCallback</code>, que recibe tres parámetros:</p>
<ul>
<li>El nombre de la ventana en la que se captura el ratón.</li>
<li>El nombre de la función que se invocará cuando se produzca cualquier evento del ratón (pasar por encima, clickar con el botón, etc).</li>
<li>Un puntero (opcional) a cualquier objeto que queramos pasarle a nuestra función.</li>
</ul>
<p>La función <code>callback</code> que hemos creado recibe cuatro parámetros: El código del evento, los valores <code>x</code> e <code>y</code>, unas opciones (<em>flags</em>) y el puntero al elemento pasado a la función.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cv</span>

<span class="c1"># Función que se invoca cuando se usa el ratón</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mouse_click</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
    <span class="c1"># En caso de que se pulse el botón izquierdo </span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">cv</span><span class="o">.</span><span class="n">EVENT_LBUTTONDOWN</span><span class="p">:</span>

        <span class="n">mensaje</span> <span class="o">=</span> <span class="s1">&#39;Boton izquierdo (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

        <span class="c1"># Mostrar texto en la imagen.</span>
        <span class="n">cv</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mensaje</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">cv</span><span class="o">.</span><span class="n">FONT_HERSHEY_TRIPLEX</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> 
        <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>

<span class="c1"># Cargar imagen y mostrarla</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="s1">&#39;lena.jpg&#39;</span><span class="p">)</span> 
<span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 

<span class="c1"># Indicar la función a llamar cuando se pulse el ratón sobre la ventana</span>
<span class="n">cv</span><span class="o">.</span><span class="n">setMouseCallback</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">mouse_click</span><span class="p">)</span>

<span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<p>Se puede encontrar más información sobre los parámetros de <code>putText</code> en <a href="https://www.geeksforgeeks.org/python-opencv-cv2-puttext-method/">este enlace</a>.</p>
<!---
El código del evento (`event`) en este ejemplo puede ser:

<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">CV_EVENT_MOUSEMOVE</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_LBUTTONDOWN</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_RBUTTONDOWN</span><span class="w"> </span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_MBUTTONDOWN</span><span class="w"> </span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_LBUTTONUP</span><span class="w"> </span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_RBUTTONUP</span><span class="w"> </span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_MBUTTONUP</span><span class="w"> </span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_LBUTTONDBLCLK</span><span class="w"> </span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_RBUTTONDBLCLK</span><span class="w"> </span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_MBUTTONDBLCLK</span><span class="w"> </span><span class="o">=</span><span class="mi">9</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_MOUSEWHEEL</span><span class="w"> </span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="w"> </span><span class="n">CV_EVENT_MOUSEHWHEEL</span><span class="w"> </span><span class="o">=</span><span class="mi">11</span>
</code></pre></div>

Los flags pueden tener estos valores:

<div class="highlight"><pre><span></span><code><span class="n">CV_EVENT_FLAG_LBUTTON</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="n">CV_EVENT_FLAG_RBUTTON</span><span class="w"> </span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="n">CV_EVENT_FLAG_MBUTTON</span><span class="w"> </span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="n">CV_EVENT_FLAG_CTRLKEY</span><span class="w"> </span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
<span class="n">CV_EVENT_FLAG_SHIFTKEY</span><span class="w"> </span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<span class="n">CV_EVENT_FLAG_ALTKEY</span><span class="w"> </span><span class="o">=</span><span class="mi">32</span>
</code></pre></div>
-->

<!---
EN PYTHON: https://docs.opencv.org/3.4/da/d6a/tutorial_trackbar.html
---->

<p>Mediante el método <code>createTrackbar</code> podemos crear un <em>trackbar</em> (también llamado <em>slider</em>) para ajustar algún valor en la ventana de forma interactiva. Al igual que ocurre con el método que gestiona el ratón, puede recibir como último parámetro una referencia a una función (en el siguiente ejemplo, <code>onChange</code>):</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>

<span class="c1"># Constante para indicar el valor máximo del slider</span>
<span class="n">alpha_slider_max</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Función que crea el trackbar</span>
<span class="k">def</span><span class="w"> </span><span class="nf">onChange</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">val</span> <span class="o">/</span> <span class="n">alpha_slider_max</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span>
    <span class="c1"># El método addWeighted se encarga de hacer la mezcla</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">addWeighted</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;Linear Blend&#39;</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>

<span class="c1"># Procesamos argumentos</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Código de ejemplo para usar un trackbar&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--imagen1&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ruta de la primera imagen&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;LinuxLogo.jpg&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--imagen2&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ruta de la segunda imagen&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;WindowsLogo.jpg&#39;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

<span class="c1"># Cargamos las imagenes y comprobamos que han podido abrirse</span>
<span class="n">img1</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">imagen1</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">imagen2</span><span class="p">)</span>

<span class="k">if</span> <span class="n">img1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No se ha podido abrir la imagen&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">imagen1</span><span class="p">)</span>
    <span class="n">quit</span><span class="p">()</span>
<span class="k">if</span> <span class="n">img2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No se ha podido abrir la imagen&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">imagen2</span><span class="p">)</span>
    <span class="n">quit</span><span class="p">()</span>

<span class="c1"># Creamos la ventana</span>
<span class="n">cv</span><span class="o">.</span><span class="n">namedWindow</span><span class="p">(</span><span class="s1">&#39;Linear Blend&#39;</span><span class="p">)</span>

<span class="c1"># Creamos el trackbar</span>
<span class="n">cv</span><span class="o">.</span><span class="n">createTrackbar</span><span class="p">(</span><span class="s1">&#39;Alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;Linear Blend&#39;</span> <span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alpha_slider_max</span><span class="p">,</span> <span class="n">onChange</span><span class="p">)</span>

<span class="c1"># Llamamos a la función que gestiona lo que se hace cuando se modifica el trackbar</span>
<span class="n">onChange</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Esperamos a que el usuario pulse una tecla para salir</span>
<span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">()</span>
</code></pre></div>
<p>Necesitarás estas dos imágenes para probar el código:</p>
<p><img alt="WindowsLogo" src="images/intro/WindowsLogo.jpg" />
<img alt="LinuxLogo" src="images/intro/LinuxLogo.jpg" /></p>
<!--
Además de los eventos de ratón y los _sliders_, podemos añadir botones con la función `createButton` (sólo si hemos compilado OpenCV con la librería QT), y también existen opciones para dibujar sobre la ventana.
-->

<p>Como alternativa a usar los elementos visuales nativos de la interfaz de OpenCV, puedes usar otras librerías más potentes como <a href="https://imgui-datascience.readthedocs.io/en/latest/">imgui</a>, aunque en principo no nos hará falta para esta asignatura.</p>
<h2 id="video">Vídeo<a class="headerlink" href="#video" title="Permanent link">&para;</a></h2>
<p>OpenCV permite cargar ficheros de vídeo o usar una <em>webcam</em> para realizar procesamiento en tiempo real. Veamos un ejemplo de detección de bordes usando una <em>webcam</em> (dará un error al ejecutarlo si el laboratorio no está equipado con cámaras, aunque si tienes un portátil puedes probarlo):</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cv2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cv</span>

<span class="n">cap</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="k">while</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># Capturar frame a frame</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Aquí podemos procesar los frames</span>
    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">);</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

        <span class="c1"># Mostrar el resultado</span>
        <span class="n">cv</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="s1">&#39;frame&#39;</span><span class="p">,</span><span class="n">edges</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="c1"># Parar cuando el usuario pulse &#39;q&#39;</span>
    <span class="k">if</span> <span class="n">cv</span><span class="o">.</span><span class="n">waitKey</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">):</span>
        <span class="k">break</span>

<span class="c1"># Cuando terminemos, paramos la captura</span>
<span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>
<p>Como puede verse, el código es bastante sencillo. Simplemente tenemos que inicializar una variable de captura de vídeo, y con <code>read</code> podemos obtener los frames para procesarlos. Si <code>ret</code> es <code>True</code> es porque el frame se ha podido leer correctamente.</p>
<p>En caso de que queramos cargar un fichero de vídeo (por ejemplo, <a href="https://github.com/opencv/opencv/blob/master/samples/data/Megamind.avi?raw=true">este</a> ), sólo hay que cambiar un par de líneas:</p>
<div class="highlight"><pre><span></span><code><span class="n">cap</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="s1">&#39;Megamind.avi&#39;</span><span class="p">)</span>

<span class="k">while</span><span class="p">(</span><span class="n">cap</span><span class="o">.</span><span class="n">isOpened</span><span class="p">()):</span>
</code></pre></div>
<p>Para <strong>guardar</strong> un fichero de vídeo hay que llamar a la función <code>VideoWriter</code> especificando el formato, <em>fps</em> (<em>frames</em> por segundo) y las dimensiones. Por ejemplo:</p>
<div class="highlight"><pre><span></span><code><span class="n">out</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="s1">&#39;output.avi&#39;</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">640</span><span class="p">,</span><span class="mi">480</span><span class="p">))</span> <span class="c1">#  AVI, 20fps, 640x480</span>
</code></pre></div>
<blockquote>
<p>Si intentas guardar directamente el vídeo resultante del programa anterior con <em>VideoWriter</em> no funcinará porque los bordes están en escala de grises y todos los formatos admitidos de vídeo necesitan frames en color.</p>
</blockquote>
<!---
Para más información puedes consultar [este enlace](https://opencv-python-tutroals.readthedocs.io/en/latest/py_tutorials/py_gui/py_video_display/py_video_display.html). -> DESACTUALIZADO
--->

<p>Estos son algunos de los formatos aceptados, aunque existen <a href="https://softron.zendesk.com/hc/en-us/articles/207695697-List-of-FourCC-codes-for-video-codecs">muchos más</a>:</p>
<div class="highlight"><pre><span></span><code><span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;j&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="c1"># AVI, recomendado en la asignatura</span>
<span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">)</span> <span class="c1"># DivX MPEG-4 codec</span>
<span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">)</span> <span class="c1"># MPEG-1 codec</span>
<span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">)</span> <span class="c1"># MPEG-4 codec</span>
<span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;i&#39;</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">)</span> <span class="c1"># DivX codec</span>
</code></pre></div>
<p>Para escribir un <em>frame</em> de vídeo podemos usar el método <code>write</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</code></pre></div>
<!---
 Ejercicio 2. Problema: Guardar videos en grayscale es complicado (ultimo parametro del constructor de Videowriter debe ser false y problemas de escritura)

Haz un programa llamado `video2.cpp` modificando el código del ejemplo de detección de bordes para que:

* Se carge [este vídeo](videos/Megamind.mp4) en lugar de usar la cámara.
* Además de mostrar los bordes por pantalla, se guarde un vídeo con los resultados llamado `Megamind-processed` en formato AVI y a 15fps.

> Pista: Este es el código para saber qué dimensiones tiene el vídeo original:

<div class="highlight"><pre><span></span><code><span class="kt">int</span><span class="w"> </span><span class="n">frame_width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_WIDTH</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="n">frame_height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cap</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">CV_CAP_PROP_FRAME_HEIGHT</span><span class="p">);</span>
</code></pre></div>
-->












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>